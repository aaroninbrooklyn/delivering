<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiYWFyb25pbmJyb29rbHluIiwiYSI6ImNtOGowMmZ0dzBjMDgycnB4eWdhZW9nZ2sifQ.Z70awiKsIraT8Mfh-T_iAg';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/aaroninbrooklyn/cm8ynjmie006x01s43bs01wo2',
    center: [-73.97, 40.68],
    zoom: 11
  });

  map.addControl(new mapboxgl.NavigationControl(), 'top-right');

  map.on('load', () => {
    const geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl
    });
    map.addControl(geocoder, 'top-left');

    // Grab all layers
    const allLayers = map.getStyle().layers;

    // Track source-layer matches
    const layerMap = {
      'bpldeliverstogether-28xcka': [],
      'Public_Restrooms_20250405-5turqf': [],
      'Bicycle_Parking_20250401-cn1akk': []
    };

    allLayers.forEach(layer => {
      const src = map.getLayer(layer.id)?.source;
      if (layerMap[src]) {
        layerMap[src].push(layer.id);
      }
    });

    // Checkbox handler
    document.querySelectorAll('.controls input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const source = e.target.dataset.layer;
        const visible = e.target.checked ? 'visible' : 'none';
        if (layerMap[source]) {
          layerMap[source].forEach(layerID => {
            try {
              if (map.getLayer(layerID) && map.getLayoutProperty(layerID, 'visibility') !== undefined) {
                map.setLayoutProperty(layerID, 'visibility', visible);
              } else {
                map.setPaintProperty(layerID, 'circle-opacity', visible === 'visible' ? 1 : 0);
              }
            } catch (err) {
              console.warn(`Couldn't toggle layer ${layerID}`, err);
            }
          });
        }
      });
    });

    // Popups on click
    map.on('click', (e) => {
      const features = map.queryRenderedFeatures(e.point, {
        layers: Object.values(layerMap).flat()
      });

      if (!features.length) return;

      const props = features[0].properties;
      const html = Object.entries(props).map(([k, v]) => `<strong>${k}</strong>: ${v}`).join('<br>');

      new mapboxgl.Popup()
        .setLngLat(e.lngLat)
        .setHTML(html)
        .addTo(map);
    });

    // Tooltip on hover
    const tooltip = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });
    map.on('mousemove', (e) => {
      const features = map.queryRenderedFeatures(e.point, {
        layers: Object.values(layerMap).flat()
      });

      if (features.length) {
        map.getCanvas().style.cursor = 'pointer';
        tooltip.setLngLat(e.lngLat)
          .setHTML(`<strong>${features[0].layer.id}</strong>`)
          .addTo(map);
      } else {
        map.getCanvas().style.cursor = '';
        tooltip.remove();
      }
    });
  });
</script>
